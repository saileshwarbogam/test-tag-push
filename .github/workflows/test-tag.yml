name: Public Beta Release

on:
  push:
    tags: '*.*.*b*'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Fetch all branches and tags
        run: |
          git fetch --all
          git fetch --tags

      - name: Get Branch Name
        id: get-branch
        run: |
          # Find the branch containing the commit
          BRANCH_NAME=$(git branch -r --contains ${{ github.sha }} | grep -o 'origin/.*' | sed 's|origin/||' | head -n 1)

          if [ -z "$BRANCH_NAME" ]; then
            echo "No branch found for the commit: ${{ github.sha }}."
            exit 1
          fi

          echo "Resolved Branch Name: $BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Debug Resolved Branch
        run: |
          echo "Branch Name: $branch_name"

      - name: Push Changes to Resolved Branch
        run: |
          # Checkout the branch to ensure it's correctly tracked
          git checkout $branch_name
          chmod +x ./bump_version.sh
          ./bump_version.sh "${{ steps.previoustag.outputs.tag }}"
          git add setup.py
          git commit -m "Hello"

          # Push the changes back to the branch
          git push origin $branch_name -f
